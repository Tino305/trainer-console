<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Trainer Console</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="icon.png">
<style>
:root{
  --bg:#0b0d10; --ink:#e9edf4; --muted:#a6b1c2; --panel:#12161c; --panel2:#171c24;
  --accent:#7dd3fc; --accent2:#a78bfa; --success:#7df2d0; --radius:18px;
}
*{box-sizing:border-box}
html,body{margin:0;background:radial-gradient(1200px 800px at -20% -20%, #0ea5e933, transparent),radial-gradient(900px 600px at 120% 0%, #a78bfa22, transparent),var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}

header{position:sticky;top:0;z-index:50;backdrop-filter:blur(10px);background:linear-gradient(180deg, rgba(10,12,16,.85), rgba(10,12,16,.55));border-bottom:1px solid rgba(255,255,255,.06)}
.container{max-width:900px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;gap:12px}
.logo{width:12px;height:12px;border-radius:9999px;background:conic-gradient(from 0deg,var(--accent),var(--success),var(--accent2),var(--accent));box-shadow:0 0 18px #7dd3fc88}
.brand{font-weight:800;letter-spacing:.2px}
.spacer{flex:1}
.btn{appearance:none;border:1px solid rgba(255,255,255,.08);background:var(--panel2);color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
.menu{position:relative}
.menu-list{position:absolute;right:0;top:46px;min-width:240px;background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;display:none}
.menu.open .menu-list{display:block}
.menu-list button{width:100%;text-align:left;background:transparent;border:0;color:var(--ink);padding:10px 12px;cursor:pointer}
.menu-list button:hover{background:rgba(255,255,255,.06)}

main{max-width:900px;margin:0 auto;padding:16px}

.splash{display:grid;grid-template-columns:1fr;gap:14px;padding:22px;border-radius:20px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)), var(--panel);border:1px solid rgba(255,255,255,.08)}
.splash .cover{width:100%;aspect-ratio:16/9;border-radius:16px;background:#0d1015;border:1px solid rgba(255,255,255,.08);display:grid;place-items:center;font-weight:800;color:#8fbaff}
.splash h1{font-size:28px;line-height:1.15;margin:6px 0}
.splash .sub{font-size:15px;color:var(--muted)}
.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
.select, select{background:var(--panel2);border:1px solid rgba(255,255,255,.08);color:var(--ink);padding:10px 14px;border-radius:12px}

.viewer{margin-top:16px;padding:18px;border-radius:18px;background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)), var(--panel);border:1px solid rgba(255,255,255,.08)}
.viewer .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
.pill{padding:6px 10px;border-radius:9999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);font-size:12px}
.title{font-size:20px;font-weight:800;letter-spacing:.2px}
.subtitle{font-size:14px;color:var(--muted);margin-top:2px;line-height:1.7}
.media{margin-top:12px;width:100%;aspect-ratio:16/9;border-radius:16px;overflow:hidden;background:#0e1218;border:1px solid rgba(255,255,255,.1);display:grid;place-items:center}
.media img,.media video{width:100%;height:100%;object-fit:cover;display:block}

.nav{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
.big{font-size:16px;padding:12px 18px;border-radius:14px}
.progress{font-size:12px;color:var(--muted)}

.footer{margin:18px 0;color:var(--muted);font-size:12px}
.notice{padding:12px;border-radius:12px;background:rgba(125,242,208,.08);border:1px solid rgba(125,242,208,.25)}

@media (min-width:680px){
  .splash{grid-template-columns:1fr 1.3fr}
}
</style>
</head>
<body>
<header>
  <div class="container">
    <div class="logo"></div>
    <div class="brand">Trainer Console</div>
    <div class="spacer"></div>
    <div class="menu" id="menu">
      <button class="btn" onclick="menu.classList.toggle('open')">☰</button>
      <div class="menu-list">
        <button onclick="openLibrary()">Choose Cartridge</button>
        <button onclick="resetProgress()">Reset Progress</button>
        <button onclick="toggleHelp()">What is RPE?</button>
      </div>
    </div>
  </div>
</header>

<main>
  <section class="splash" id="splash"></section>
  <section class="viewer" id="viewer" hidden>
    <div class="title" id="exTitle"></div>
    <div class="subtitle" id="exDesc"></div>
    <div class="media" id="exMedia"><span class="pill">Loading demo…</span></div>
    <div class="meta">
      <span class="pill" id="exSets"></span>
      <span class="pill" id="exReps"></span>
      <span class="pill" id="exRest"></span>
      <span class="pill" id="exRpe"></span>
    </div>
    <div class="nav">
      <button class="btn big" id="prevBtn">← Prev</button>
      <div class="progress" id="progress"></div>
      <button class="btn big" id="nextBtn">Next →</button>
    </div>
  </section>

  <div class="footer">
    <div class="notice" id="helpBox" hidden>
      <strong>RPE (Rate of Perceived Exertion)</strong> is a 1–10 effort scale. In this plan use: 6 = easy, 8 = ~2 reps left, 9 = ~1 rep left, 10 = max. If a set feels like RPE 6, add weight next time; if it’s 9–10 when it shouldn’t be, reduce a bit.
    </div>
  </div>
</main>

<script>
let LIB=null;
let cartIdx=0, dayIdx=0, exIdx=0;
let current=null;

async function loadLibrary(){
  const res = await fetch('./cartridges.json');
  LIB = await res.json();
  if(!LIB || !Array.isArray(LIB.cartridges)) throw new Error('Invalid library');
  // default select first cartridge
  setCartridge(0);
}

function setCartridge(idx){
  cartIdx = idx;
  current = LIB.cartridges[cartIdx];
  dayIdx = 0; exIdx = 0;
  renderSplash();
  renderExercise();
}

function renderSplash(){
  const el = document.getElementById('splash');
  el.innerHTML = `
    <div class="cover" style="background-image:radial-gradient(circle at 20% 20%, #7dd3fc33, transparent 60%), radial-gradient(circle at 80% 10%, #a78bfa33, transparent 60%), linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); background-blend-mode:screen;">
      <div>${current.name}</div>
    </div>
    <div>
      <h1>${current.name}</h1>
      <div class="sub">${current.about||''}</div>
      <div class="controls" style="margin-top:12px">
        <label>Day</label>
        <select id="daySel"></select>
        <button class="btn" onclick="start()">Start</button>
        <button class="btn" onclick="openLibrary()">Library</button>
      </div>
    </div>
  `;
  const sel = document.getElementById('daySel');
  const days = current.plan.days || [];
  sel.innerHTML='';
  for(let i=0;i<days.length;i++){ const o=document.createElement('option'); o.value=i; o.textContent = `Day ${i+1} — ${days[i].title}`; sel.appendChild(o); }
  sel.value = dayIdx;
  sel.onchange = e=>{ dayIdx = parseInt(e.target.value); exIdx = 0; renderExercise(); };
}

function start(){
  document.getElementById('viewer').hidden=false;
  document.getElementById('splash').scrollIntoView({behavior:'smooth'});
}

function openLibrary(){
  const names = LIB.cartridges.map((c,i)=> `${i===cartIdx?'• ':''}${c.name}`).join('\\n');
  const pick = prompt('Choose cartridge by number:\\n' + LIB.cartridges.map((c,i)=> `[${i}] ${c.name}`).join('\\n'));
  if(pick===null) return;
  const n = parseInt(pick);
  if(Number.isInteger(n) && n>=0 && n<LIB.cartridges.length){ setCartridge(n); }
}

function resetProgress(){ exIdx = 0; renderExercise(); }
function toggleHelp(){ const box=document.getElementById('helpBox'); box.hidden = !box.hidden; }

function getCurrentExercise(){
  const day = current?.plan?.days?.[dayIdx] || {exercises:[]};
  return { ex: day.exercises?.[exIdx] || null, count: day.exercises?.length||0, day };
}

async function resolveGiphy(url){
  try{
    const r = await fetch(`https://giphy.com/services/oembed?url=${encodeURIComponent(url)}`);
    if(!r.ok) throw new Error('oEmbed failed');
    const data = await r.json();
    return data.url || data.image || null;
  }catch(e){ console.warn(e); return null; }
}

async function renderExercise(){
  const {ex, count, day} = getCurrentExercise();
  const titleEl = document.getElementById('exTitle');
  const descEl = document.getElementById('exDesc');
  const mediaEl = document.getElementById('exMedia');
  const setsEl = document.getElementById('exSets');
  const repsEl = document.getElementById('exReps');
  const restEl = document.getElementById('exRest');
  const rpeEl = document.getElementById('exRpe');
  const progEl = document.getElementById('progress');

  if(!ex){ titleEl.textContent = 'No exercise'; descEl.textContent=''; mediaEl.innerHTML=''; setsEl.textContent=''; repsEl.textContent=''; restEl.textContent=''; rpeEl.textContent=''; progEl.textContent=''; return; }

  titleEl.textContent = `${day.title} — ${ex.name}`;
  descEl.textContent = ex.desc || '';
  setsEl.textContent = `Sets ${ex.sets||3}`;
  repsEl.textContent = `Reps ${ex.reps||8}`;
  restEl.textContent = `Rest ${ex.rest||'60s'}`;
  rpeEl.textContent = `RPE ${ex.rpe||'7–8'}`;
  progEl.textContent = `Exercise ${exIdx+1} / ${count}`;

  mediaEl.innerHTML = '<span class="pill">Loading demo…</span>';
  let url = ex.gif;
  if(ex.giphy){
    const resolved = await resolveGiphy(ex.giphy);
    if(resolved) url = resolved;
  }
  if(url){
    if(url.endsWith('.mp4')) mediaEl.innerHTML = `<video src="${url}" autoplay muted loop playsinline></video>`;
    else mediaEl.innerHTML = `<img src="${url}" alt="${ex.name} demo" loading="lazy">`;
  }else{
    mediaEl.innerHTML = '<span class="pill">No media</span>';
  }
}

// Navigation
document.getElementById('prevBtn').addEventListener('click', ()=>{ const {count}=getCurrentExercise(); exIdx = Math.max(0, exIdx-1); renderExercise(); });
document.getElementById('nextBtn').addEventListener('click', ()=>{ const {count}=getCurrentExercise(); exIdx = Math.min(count-1, exIdx+1); renderExercise(); });

// Swipe support
let touchStartX=null, touchStartY=null;
function onTouchStart(e){ const t=e.changedTouches[0]; touchStartX=t.clientX; touchStartY=t.clientY; }
function onTouchEnd(e){
  const t=e.changedTouches[0]; const dx=t.clientX - touchStartX; const dy=t.clientY - touchStartY;
  if(Math.abs(dx)>50 && Math.abs(dy)<40){
    if(dx<0) document.getElementById('nextBtn').click();
    else document.getElementById('prevBtn').click();
  }
  touchStartX=null; touchStartY=null;
}
document.getElementById('viewer').addEventListener('touchstart', onTouchStart, {passive:true});
document.getElementById('viewer').addEventListener('touchend', onTouchEnd, {passive:true});

// Keyboard arrows
window.addEventListener('keydown', (e)=>{
  if(e.key==='ArrowRight') document.getElementById('nextBtn').click();
  if(e.key==='ArrowLeft') document.getElementById('prevBtn').click();
});

// Boot
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js')); }
loadLibrary().catch(err=>{ document.getElementById('splash').innerHTML='<div class="notice">Failed to load library.</div>'; console.error(err); });
</script>
</body>
</html>
